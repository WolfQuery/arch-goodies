#!/usr/bin/env bash

# yt-dlp-auto.sh - Download YouTube audio to ~/Music/<Artist>/<Album> or ~/Music/<Artist> (singles)
# Usage: yt-dlp-auto URL "Artist Name" "Album Name (optional)"

# Check arguments
if [ -z "$1" ] || [ -z "$2" ]; then
    echo "Usage: $0 URL \"Artist Name\" [\"Album Name (optional)\"]"
    echo "Example: $0 https://youtu.be/abcd1234 \"Peak Divide\" \"UNBEATABLE OST\""
    exit 1
fi

URL="$1"
ARTIST="$2"
ALBUM="$3"

# Set base directory
BASE_DIR="$HOME/Music"

# Determine output folder
if [ -z "$ALBUM" ]; then
    OUT_DIR="$BASE_DIR/$ARTIST"
else
    OUT_DIR="$BASE_DIR/$ARTIST/$ALBUM"
fi

mkdir -p "$OUT_DIR"

# yt-dlp command
yt-dlp -f "bestaudio[ext=m4a]/bestaudio[ext=webm]/best" \
    --extract-audio --audio-format mp3 --audio-quality 0 \
    --extractor-args "youtube:player_client=android" \
    --cookies-from-browser firefox \
    --embed-thumbnail \
    --ignore-errors \
    --restrict-filenames \
    --fragment-retries 10 --retries 10 \
    -o "$OUT_DIR/%(title)s.%(ext)s" \
    --exec "ffmpeg -y -i {} \
        -metadata artist='$ARTIST' \
        $( [ -n \"$ALBUM\" ] && echo -metadata album=\"$ALBUM\" ) \
        -codec copy {}" \
    "$URL"
